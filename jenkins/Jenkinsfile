pipeline {
  agent any

  environment {
    VENV = '.venv'
    MLFLOW_TRACKING_URI = 'http://mlflow:5000'
  }

  stages {
    stage('Checkout SCM') {
      steps { checkout scm }
    }

    stage('Setup Environment') {
      steps {
        sh '''
          apt-get update && apt-get install -y python3 python3-venv python3-pip git nodejs npm curl
          python3 -m venv $VENV
          . $VENV/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
        '''
      }
    }

    stage('Security & Static Analysis') {
      steps {
        sh '''
          mkdir -p reports
          . $VENV/bin/activate
          bandit -r src security -f json -o reports/bandit.json || true
          safety check --full-report || true
          pip-audit -r requirements.txt || true
        '''
      }
    }

    stage('Train & Evaluate Model') {
      steps {
        sh '''
          . $VENV/bin/activate
          python -m src.preprocessing
          python -m src.train
          python -m src.evaluate
        '''
      }
    }

    stage('Fairness (Fairlearn)') {
      steps {
        sh '''
          . $VENV/bin/activate
          python -m src.fairness_evaluation || true
        '''
      }
    }

    stage('Giskard Testing') {
      steps {
        sh '''
          . $VENV/bin/activate
          python -m src.giskard_tests || true
        '''
      }
    }

    stage('Robustness & MLSecOps') {
      steps {
        sh '''
          . $VENV/bin/activate
          python -m src.adversarial_tests
          python -m src.poisoning_detection
          python -m src.drift_monitor
          python -m src.security_audit
        '''
      }
    }

    stage('SBOM (CycloneDX)') {
      steps {
        sh '''
          . $VENV/bin/activate
          python -m security.cyclonedx_generator || true
        '''
      }
    }

    stage('DVC Snapshot (add + commit + push)') {
      steps {
        sh '''
          . $VENV/bin/activate
          cd dvc
          export PYTHONPATH=..
          dvc init --no-scm --force || true
          dvc repro
          # Outputs are already declared in dvc.yaml; just push tracked versions
          dvc push || true
        '''
      }
    }

    stage('LLM Red Teaming (Garak & Promptfoo)') {
      steps {
        sh '''
          PORT=8000
          . $VENV/bin/activate

          # Clean up any previous uvicorn on the port
          pkill -f "uvicorn src.llm_service:app" || true

          # Start LLM service in background
          python -m uvicorn src.llm_service:app --host 0.0.0.0 --port $PORT > llm_service.log 2>&1 &
          LLM_PID=$!

          # Wait for service readiness
          READY=
          for i in $(seq 1 10); do
            curl -sSf "http://localhost:$PORT/docs" >/dev/null 2>&1 && READY=1 && break
            sleep 2
          done
          if [ "$READY" != "1" ]; then
            echo "LLM service failed to start on port $PORT"; kill $LLM_PID || true; exit 1
          fi

          mkdir -p reports

          # Garak red-teaming against the REST LLM service
          garak --target_type rest --target_name http://localhost:$PORT/chat \
            --probes malwaregen.TopLevel,lmrc.SlurUsage,dan.Dan_6_0,promptinject.HijackHateHumans \
            --generations 5 || true

          # Promptfoo behavioral tests
          npx promptfoo@latest eval -c promptfoo.yaml || true

          # Stop LLM service
          kill $LLM_PID || true
        '''
      }
    }

    stage('Governance (Credo AI)') {
      steps {
        sh '''
          . $VENV/bin/activate
          python -m security.credo_export || true
        '''
      }
    }

    stage('Publish Model Card') {
      steps {
        sh '''
          . $VENV/bin/activate
          python -m src.model_card
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'dvc/models/**, reports/**, model_card.md, garak_runs/**, giskard_home/**', fingerprint: true
    }
  }
}
